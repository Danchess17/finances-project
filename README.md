# Оценка риска ликвидности портфеля ценных бумаг

Сбор датасетов в различных режимах, написание CLI-программ, отрисовка графиков, документация по запуску программ: Ишханян Даниэль

Анализ данных и нахождение оптимального портфеля: Чесноков Александр

- [data_loader.py](data_loader.py) - скрипт для сбора данных из Yahoo finances
- [moex_data_loader.py](moex_data_loader.py) - скрипт для сбора данных из moex
- [research.ipynb](research.ipynb) - Анализ данных и нахождение оптимальных портфелей (какую долю должен занимать каждый актив)
- [Отчет.pdf](%D0%9E%D1%82%D1%87%D0%B5%D1%82.pdf) - pdf отчет (не обновлялся с предыдущей итерации)


## run_moex_data_loader.py - Загрузка данных с MOEX и расчет оптимальных весов портфеля

### Описание

Скрипт для загрузки исторических данных российских акций с биржи MOEX, создания графиков High/Low цен и расчета оптимальных весов портфеля по методу минимизации LVaR (Liquidity-adjusted Value at Risk).

### Основные параметры

#### Обязательные параметры:
- `--portfolio SYMBOL1 SYMBOL2 ...` (или `--symbols`) - Список тикеров акций для загрузки (например: SBER GAZP LKOH)

#### Опциональные параметры дат:
- `--start DATE` (или `--start-date`) - Дата начала в формате YYYY-MM-DD. По умолчанию: 3 года назад от даты окончания
- `--end DATE` (или `--end-date`) - Дата окончания в формате YYYY-MM-DD. По умолчанию: вчерашний день

#### Параметры портфеля:
- `--portfolio-name NAME` - Название портфеля (для имени файлов). По умолчанию: объединенные тикеры через подчеркивание

#### Параметры вывода:
- `--plot` (или `--plot-graph`) - Создать график High/Low для каждой акции
- `--weights` - Рассчитать оптимальные веса портфеля (минимизация LVaR) и показать график с весами
- `--plot-returns` - Построить график доходности портфеля для train/test периодов (требует `--weights`)
- `--train-ratio RATIO` - Доля данных для train периода (по умолчанию: 0.7, т.е. 70% train / 30% test)
- `--show` - Показать график в окне (в дополнение к сохранению в файл)
- `--plot-output PATH` - Путь для сохранения графика (по умолчанию: auto-generated)
- `--csv-output PATH` - Путь для сохранения CSV (по умолчанию: `data/russian_portfolio/`)
- `--corwin-schultz` - Использовать метод Корвина-Шульца для расчета спреда (по умолчанию: простая формула (High-Low)/Close)
- `--debug` - Показать подробную информацию: этапы загрузки, математические выкладки, проверку оптимальности весов

### Режимы работы

#### 1. Обычный режим (без `--debug`):
Выводит только:
- Путь к сохраненному CSV файлу
- Путь к графику (если используется `--plot` или `--weights`)
- Веса портфеля (если используется `--weights`)

#### 2. Debug режим (с `--debug`):
Выводит всю подробную информацию:
- Этапы загрузки данных с MOEX
- Детальную информацию о реальных датах загрузки
- Все математические выкладки (спреды, ковариационная матрица, метрики портфеля)
- Проверку оптимальности весов (сравнение с альтернативными стратегиями)
- График сравнения LVaR для разных стратегий

### Примеры использования

#### Базовые примеры:

```bash
# Загрузка портфеля с графиком (автоматически: последние 3 года до вчера)
python run_moex_data_loader.py --portfolio SBER GAZP LKOH --plot

# С подробной информацией о реальных датах (debug режим)
python run_moex_data_loader.py --portfolio SBER GAZP LKOH --plot --debug

# Загрузка с указанием периода
python run_moex_data_loader.py --start 2023-01-01 --end 2024-01-01 --portfolio SBER GAZP LKOH --plot

# Загрузка до определенной даты (start будет автоматически 3 года назад)
python run_moex_data_loader.py --end 2024-01-01 --portfolio SBER GAZP

# Загрузка с указанием имени портфеля
python run_moex_data_loader.py --portfolio SBER GAZP --portfolio-name MY_PORTFOLIO --plot
```

#### Примеры с графиками:

```bash
# Загрузка с показом графика в окне
python run_moex_data_loader.py --portfolio SBER GAZP LKOH --plot --show

# Сохранение графика в указанное место
python run_moex_data_loader.py --portfolio SBER GAZP LKOH --plot --plot-output my_chart.png
```

#### Примеры расчета оптимальных весов:

```bash
# Расчет оптимальных весов портфеля (минимизация LVaR)
python run_moex_data_loader.py --portfolio SBER GAZP LKOH --weights

# Расчет весов с методом Корвина-Шульца для спреда
python run_moex_data_loader.py --portfolio SBER GAZP LKOH --weights --corwin-schultz

# Расчет весов с показом графика
python run_moex_data_loader.py --portfolio SBER GAZP LKOH --weights --show

# Расчет весов с полной математической информацией (debug режим)
python run_moex_data_loader.py --portfolio SBER GAZP LKOH --weights --show --debug

# Расчет весов с методом Корвина-Шульца и debug режимом
python run_moex_data_loader.py --portfolio SBER GAZP LKOH --weights --corwin-schultz --debug

# Расчет весов с указанием периода
python run_moex_data_loader.py --start 2023-01-01 --end 2024-01-01 --portfolio SBER GAZP LKOH --weights --debug
```

#### Примеры построения графиков доходности портфеля:

```bash
# Построить график доходности для train/test периодов (70/30)
python run_moex_data_loader.py --portfolio SBER GAZP LKOH --weights --plot-returns

# С другим соотношением train/test (например, 80/20)
python run_moex_data_loader.py --portfolio SBER GAZP LKOH --weights --plot-returns --train-ratio 0.8

# С показом графиков в окне
python run_moex_data_loader.py --portfolio SBER GAZP LKOH --weights --plot-returns --show

# С полной информацией (debug режим)
python run_moex_data_loader.py --portfolio SBER GAZP LKOH --weights --plot-returns --debug

# С методом Корвина-Шульца
python run_moex_data_loader.py --portfolio SBER GAZP LKOH --weights --plot-returns --corwin-schultz --debug
```

### Выходные файлы

#### CSV файлы:
- Портфельные данные: `data/russian_portfolio/{portfolio_name}_{start_date}_{end_date}_moex.csv`
- Индивидуальные акции: `data/individual/{SYMBOL}_{start_date}_{end_date}_moex.csv`

#### Графики:
- График High/Low (с `--plot`): `high_low_chart_{start_date}_to_{end_date}.png`
- График с весами (с `--weights`): `portfolio_weights_{start_date}_to_{end_date}.png`
- График сравнения LVaR (с `--weights --debug`): `lvar_comparison.png`
- Графики доходности портфеля (с `--weights --plot-returns`):
  - Общий график (train + test): `portfolio_returns_train_test_{start_date}_{end_date}_all.png`
  - График TRAIN периода: `portfolio_returns_train_test_{start_date}_{end_date}_train.png`
  - График TEST периода: `portfolio_returns_train_test_{start_date}_{end_date}_test.png`

### Методология расчета оптимальных весов

При использовании флага `--weights` скрипт:

1. **Рассчитывает спреды** для каждой акции (возвращает массив значений спреда для каждого дня):
   - **По умолчанию (без `--corwin-schultz`)**: простая формула `(High - Low) / Close` для каждого дня
   - **С флагом `--corwin-schultz`**: метод Корвина-Шульца (Corwin-Schultz), который учитывает волатильность и использует данные за два дня
2. **Вычисляет ковариационную матрицу** доходностей акций
3. **Минимизирует LVaR** (Liquidity-adjusted Value at Risk) через единый метод `compute_lvar()`:
   - Внутри `compute_lvar()` вычисляется медиана спредов (из массива спредов для каждого актива)
   - Формула LVaR: `LVaR = VaR + Стоимость_ликвидности`
   - `VaR = z × √(w^T × Σ × w)` (где z ≈ 1.645 для 95% доверительного уровня)
   - `Стоимость_ликвидности = 0.5 × (w^T × s)` (где s - вектор медиан спредов)
   - Все расчеты LVaR используют единый метод `compute_lvar()` для консистентности
4. **Проверяет оптимальность** весов, сравнивая с:
   - Равномерным распределением
   - Портфелями из одной акции
   - Случайными комбинациями весов
   - Альтернативными стратегиями

5. **Строит графики доходности** (с флагом `--plot-returns`):
   - Разделяет данные на train/test периоды (по умолчанию 70/30)
   - Рассчитывает оптимальные веса на train периоде
   - Строит накопленную доходность портфеля для обоих периодов
   - Сравнивает оптимальные веса с 1000+ альтернативными стратегиями:
     * Равные веса
     * Портфели из одной акции
     * 1000 случайных наборов весов (разные распределения Dirichlet)
     * Веса с перекосом (60%, 70%, 80%, 90% в каждый актив)
     * Веса с концентрацией на двух/трех активах
   - Создает три графика: общий (train+test), отдельно train, отдельно test

#### Методы расчета спреда:

**Простая формула (по умолчанию):**
- Формула: `spread = (High - Low) / Close` для каждого дня
- Медиана вычисляется внутри `compute_lvar()`

**Метод Корвина-Шульца (с флагом `--corwin-schultz`):**
- Использует более сложную формулу, учитывающую волатильность
- Требует данные за два дня для расчета
- Если результат < 0, возвращается 0
- Подробнее: Corwin & Schultz (2011)

### Графики доходности портфеля (с `--plot-returns`)

Функция построения графиков доходности демонстрирует эффективность оптимальных весов:

1. **Разделение на периоды:**
   - Данные автоматически разделяются на train и test периоды
   - По умолчанию: 70% train / 30% test (настраивается через `--train-ratio`)
   - Оптимальные веса рассчитываются только на train периоде
   - Затем применяются к обоим периодам для оценки

2. **Расчет доходности:**
   - Доходность = скалярное произведение весов на цены активов
   - Цена актива = среднее между High и Low за день: `(High + Low) / 2`
   - Накопленная доходность нормализуется к начальному значению (первый день = 1.0)

3. **Сравнение стратегий:**
   - **Оптимальные веса**: жирная синяя линия (linewidth=4) - должна быть выше остальных
   - **Альтернативные стратегии**: темно-серые линии (linewidth=2, alpha=0.6)
   - Генерируется 1000+ различных альтернативных стратегий для сравнения

4. **Три графика:**
   - **Общий график**: показывает train и test периоды вместе с вертикальной разделительной линией
   - **График TRAIN**: только train период, для детального анализа
   - **График TEST**: только test период, для проверки на новых данных

5. **Интерпретация:**
   - Если оптимальные веса действительно оптимальны, они должны давать наибольшую доходность
   - График наглядно демонстрирует превосходство оптимальной стратегии
   - Показывает стабильность результатов на тестовом периоде

### Формат вывода

#### Обычный режим (без `--debug`):
```
data/russian_portfolio/SBER_GAZP_LKOH_2022-11-25_2025-11-24_moex.csv
portfolio_weights_2022-11-25_to_2025-11-24.png

Веса портфеля:
  SBER: 0.5120 (51.20%)
  GAZP: 0.0270 (2.70%)
  LKOH: 0.4609 (46.09%)
```

#### Debug режим (с `--debug`):
- Все этапы загрузки данных
- Детальная информация о реальных датах
- Все математические расчеты и формулы
- Подробная проверка оптимальности весов
- Сравнительные графики LVaR

### Примечания

- Данные загружаются с биржи MOEX с автоматической пагинацией (до 100 записей за запрос)
- Дубликаты дат автоматически удаляются (остается последняя запись)
- При расчете весов требуется минимум 2 акции в портфеле
- В debug режиме все логи выводятся в консоль; в обычном режиме - только итоговые результаты

### См. также

- [moex_data_loader.py](moex_data_loader.py) - модуль загрузки данных с MOEX
- [research.ipynb](research.ipynb) - Анализ данных и методология расчета оптимальных весов